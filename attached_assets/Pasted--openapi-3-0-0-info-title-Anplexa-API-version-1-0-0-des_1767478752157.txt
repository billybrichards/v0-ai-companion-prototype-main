{"openapi":"3.0.0","info":{"title":"Anplexa API","version":"1.0.0","description":"# Unrestricted AI Companion API\n\nBuild immersive adult AI experiences without limitations.\n\n## Authentication\n\nThis API supports two authentication methods:\n\n### 1. API Key Authentication (Recommended for Server-to-Server)\nInclude your API key in the `X-API-Key` header:\n```\nX-API-Key: your-api-key-here\n```\n\n**How to get an API key:**\n- Subscribe to a paid plan via the dashboard\n- Navigate to Settings ‚Üí API Keys\n- Generate a new API key\n\n### 2. JWT Bearer Token (Recommended for User Sessions)\nInclude the JWT token in the Authorization header:\n```\nAuthorization: Bearer your-jwt-token\n```\n\nObtain tokens via the `/api/auth/login` endpoint.\n\n## Rate Limits\n\n| Tier | Limit | Reset |\n|------|-------|-------|\n| Free | 50 calls/month | Monthly |\n| Unlimited | No limits | - |\n\n## Quick Start Examples\n\n### Chat with AI (curl)\n```bash\ncurl -X POST \"https://api.anplexa.com/api/chat\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-API-Key: your-api-key\" \\\n  -d '{\"message\": \"Hello, how are you?\"}'\n```\n\n### Chat with AI (Node.js)\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/chat', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    'X-API-Key': 'your-api-key'\n  },\n  body: JSON.stringify({ message: 'Hello, how are you?' })\n});\n\nconst reader = response.body.getReader();\nconst decoder = new TextDecoder();\n\nwhile (true) {\n  const { done, value } = await reader.read();\n  if (done) break;\n  console.log(decoder.decode(value));\n}\n```\n"},"servers":[{"url":"/","description":"Current server"}],"tags":[{"name":"Authentication","description":"User registration, login, and session management"},{"name":"Chat","description":"AI companion chat endpoints"},{"name":"Conversations","description":"Conversation history management"},{"name":"Settings","description":"User preferences and settings"},{"name":"Stripe","description":"Subscription management and payment processing"},{"name":"Public","description":"Public endpoints for landing pages and lead capture (no authentication required)"},{"name":"Funnel","description":"External funnel integration endpoints - create users, manage subscriptions (requires funnel API key)"},{"name":"Admin üîê","description":"‚ö†Ô∏è ADMIN ONLY - Administrative endpoints (requires admin role). These endpoints require admin authentication."},{"name":"Health","description":"System health checks"},{"name":"Webhooks","description":"External webhook integrations"}],"paths":{"/api/auth/register":{"post":{"tags":["Authentication"],"summary":"Register a new user","description":"Create a new user account. First user becomes admin.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/auth/register\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"user@example.com\", \"password\": \"securepass123\", \"displayName\": \"John Doe\"}'\n```\n\n**Example (Node.js):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/auth/register', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    email: 'user@example.com',\n    password: 'securepass123',\n    displayName: 'John Doe'\n  })\n});\nconst data = await response.json();\nconsole.log(data.accessToken);\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email","password"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com"},"password":{"type":"string","minLength":6,"example":"password123"},"displayName":{"type":"string","example":"John Doe"}}}}}},"responses":{"201":{"description":"Registration successful","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Registration successful"},"user":{"type":"object","properties":{"id":{"type":"string","example":"uuid-here"},"email":{"type":"string","example":"user@example.com"},"displayName":{"type":"string","example":"John Doe"},"isAdmin":{"type":"boolean","example":false}}},"accessToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."},"refreshToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."}}}}}},"400":{"description":"Validation error or email already registered","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string","example":"Email already registered"}}}}}}}}},"/api/auth/login":{"post":{"tags":["Authentication"],"summary":"Login user","description":"Authenticate with email and password to receive JWT tokens.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/auth/login\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"user@example.com\", \"password\": \"password123\"}'\n```\n\n**Example (Node.js):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/auth/login', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    email: 'user@example.com',\n    password: 'password123'\n  })\n});\nconst { accessToken, refreshToken } = await response.json();\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email","password"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com"},"password":{"type":"string","example":"password123"}}}}}},"responses":{"200":{"description":"Login successful","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Login successful"},"user":{"type":"object","properties":{"id":{"type":"string","example":"uuid-here"},"email":{"type":"string","example":"user@example.com"},"displayName":{"type":"string","example":"John Doe"},"isAdmin":{"type":"boolean","example":false}}},"accessToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."},"refreshToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."}}}}}},"401":{"description":"Invalid credentials","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string","example":"Invalid email or password"}}}}}}}}},"/api/auth/refresh":{"post":{"tags":["Authentication"],"summary":"Refresh access token","description":"Exchange a valid refresh token for a new access token pair.","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["refreshToken"],"properties":{"refreshToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."}}}}}},"responses":{"200":{"description":"New tokens returned","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Token refreshed"},"accessToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."},"refreshToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."}}}}}},"401":{"description":"Invalid or expired refresh token"}}}},"/api/auth/logout":{"post":{"tags":["Authentication"],"summary":"Logout user","description":"Invalidate the current session or all sessions.","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"refreshToken":{"type":"string","description":"Optional, logs out specific session"}}}}}},"responses":{"200":{"description":"Logged out successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Logged out successfully"}}}}}}}}},"/api/auth/me":{"get":{"tags":["Authentication"],"summary":"Get current user","description":"Retrieve the authenticated user's profile and preferences.","security":[{"bearerAuth":[]},{"apiKey":[]}],"responses":{"200":{"description":"User info and preferences","content":{"application/json":{"schema":{"type":"object","properties":{"user":{"type":"object","properties":{"id":{"type":"string","example":"uuid-here"},"email":{"type":"string","example":"user@example.com"},"displayName":{"type":"string","example":"John Doe"},"isAdmin":{"type":"boolean","example":false},"storagePreference":{"type":"string","example":"server"},"chatName":{"type":"string","example":"Alex","nullable":true},"personalityMode":{"type":"string","enum":["nurturing","playful","dominant","filthy_sexy","intimate_companion","intellectual_muse"],"example":"nurturing"},"preferredGender":{"type":"string","enum":["male","female","non-binary","custom"],"example":"female"},"customGender":{"type":"string","nullable":true,"example":null}}},"preferences":{"type":"object","nullable":true,"properties":{"gender":{"type":"string","example":"female"},"preferredLength":{"type":"string","example":"moderate"},"preferredStyle":{"type":"string","example":"thoughtful"}}}}}}}},"401":{"description":"Not authenticated"}}}},"/api/auth/chat-name":{"put":{"tags":["Authentication"],"summary":"Update chat name","description":"Update the user's preferred name for personalized AI interactions. The AI will address the user by this name during conversations.\n\n**Example (curl):**\n```bash\ncurl -X PUT \"https://api.anplexa.com/api/auth/chat-name\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -d '{\"name\": \"Alex\"}'\n```\n\n**Example (Node.js):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/auth/chat-name', {\n  method: 'PUT',\n  headers: {\n    'Content-Type': 'application/json',\n    'Authorization': 'Bearer ' + accessToken\n  },\n  body: JSON.stringify({ name: 'Alex' })\n});\nconst data = await response.json();\nconsole.log(data.chatName); // \"Alex\"\n```","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["name"],"properties":{"name":{"type":"string","maxLength":50,"example":"Alex","description":"The name the AI should use to address the user"}}}}}},"responses":{"200":{"description":"Chat name updated successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Chat name updated"},"chatName":{"type":"string","example":"Alex"}}}}}},"400":{"description":"Invalid name provided"},"401":{"description":"Not authenticated"}}}},"/api/auth/personality-mode":{"put":{"tags":["Authentication"],"summary":"Update personality mode","description":"Update the user's preferred AI personality mode. This affects how the AI companion responds to the user.\n\n**Available Modes:**\n- `nurturing`: Gentle, grounding, and quietly reassuring. Best for hesitant, lonely, or anxious users.\n- `playful`: Relaxed, curious, and subtly charming. Best for witty, exploratory conversations.\n- `dominant`: Calm, steady, and confident leadership. Best for users wanting direction.\n- `filthy_sexy`: Raw, uninhibited, and intensely desire-focused. Best for explicit roleplay and unrestricted fantasy.\n- `intimate_companion`: Deeply connected, emotionally intimate, and devoted. Best for emotional bonding and romance.\n- `intellectual_muse`: Sharp, inspiring, and intellectually stimulating. Best for brainstorming and deep discussion.\n\n**Example (curl):**\n```bash\ncurl -X PUT \"https://api.anplexa.com/api/auth/personality-mode\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -d '{\"mode\": \"filthy_sexy\"}'\n```","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["mode"],"properties":{"mode":{"type":"string","enum":["nurturing","playful","dominant","filthy_sexy","intimate_companion","intellectual_muse"],"example":"playful","description":"The AI personality mode"}}}}}},"responses":{"200":{"description":"Personality mode updated successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Personality mode updated successfully"},"personalityMode":{"type":"string","example":"playful"}}}}}},"400":{"description":"Invalid mode provided"},"401":{"description":"Not authenticated"}}}},"/api/auth/personality-modes":{"get":{"tags":["Authentication"],"summary":"List personality modes","description":"Get all available AI personality modes with descriptions and use cases.","responses":{"200":{"description":"List of available personality modes","content":{"application/json":{"schema":{"type":"object","properties":{"modes":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string","example":"nurturing"},"name":{"type":"string","example":"Nurturing / Safe Haven"},"description":{"type":"string","example":"Gentle, grounding, and quietly reassuring presence"},"useCases":{"type":"array","items":{"type":"string"},"example":["First-time users","Emotional contexts"]}}}},"default":{"type":"string","example":"nurturing"}}}}}}}}},"/api/auth/gender":{"put":{"tags":["Authentication"],"summary":"Update AI companion gender","description":"Update the user's preferred AI companion gender. This affects the AI's identity and pronouns.\n\n**Available Genders:**\n- `female`: The AI uses she/her pronouns (default)\n- `male`: The AI uses he/him pronouns\n- `non-binary`: The AI uses they/them pronouns\n- `custom`: Define a custom gender identity\n\n**Example (curl):**\n```bash\ncurl -X PUT \"https://api.anplexa.com/api/auth/gender\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -d '{\"gender\": \"male\"}'\n```\n\n**Custom gender example:**\n```bash\ncurl -X PUT \"https://api.anplexa.com/api/auth/gender\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -d '{\"gender\": \"custom\", \"customGender\": \"agender companion\"}'\n```","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["gender"],"properties":{"gender":{"type":"string","enum":["male","female","non-binary","custom"],"example":"female","description":"The AI companion gender"},"customGender":{"type":"string","maxLength":100,"example":"agender companion","description":"Required when gender is \"custom\""}}}}}},"responses":{"200":{"description":"Gender preference updated successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Gender preference updated successfully"},"gender":{"type":"string","example":"female"},"customGender":{"type":"string","nullable":true,"example":null}}}}}},"400":{"description":"Invalid gender or missing customGender for custom type"},"401":{"description":"Not authenticated"}}}},"/api/auth/genders":{"get":{"tags":["Authentication"],"summary":"List gender options","description":"Get all available AI companion gender options.","responses":{"200":{"description":"List of available gender options","content":{"application/json":{"schema":{"type":"object","properties":{"genders":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string","example":"female"},"name":{"type":"string","example":"Female"},"description":{"type":"string","example":"The AI companion identifies as female with she/her pronouns"}}}},"default":{"type":"string","example":"female"}}}}}}}}},"/api/auth/forgot-password":{"post":{"tags":["Authentication"],"summary":"Request password reset","description":"Request a password reset email. If an account exists with the provided email, a reset link will be sent.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/auth/forgot-password\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"user@example.com\"}'\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com"}}}}}},"responses":{"200":{"description":"Password reset email sent (always returns success to prevent email enumeration)","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"If an account exists with this email, a password reset link has been sent"}}}}}}}}},"/api/auth/reset-password":{"post":{"tags":["Authentication"],"summary":"Reset password with token","description":"Reset the user's password using the token from the password reset email.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/auth/reset-password\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"token\": \"reset-token-from-email\", \"newPassword\": \"newSecurePassword123\"}'\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["token","newPassword"],"properties":{"token":{"type":"string","example":"abc123def456..."},"newPassword":{"type":"string","minLength":6,"example":"newSecurePassword123"}}}}}},"responses":{"200":{"description":"Password reset successful","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Password reset successful"}}}}}},"400":{"description":"Invalid or expired reset token"}}}},"/api/auth/magic-link":{"post":{"tags":["Authentication"],"summary":"Request magic link login","description":"Request a magic link email for passwordless authentication. Click the link in the email to sign in without a password.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/auth/magic-link\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"user@example.com\"}'\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com"}}}}}},"responses":{"200":{"description":"Magic link sent (always returns success to prevent email enumeration)","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"If an account exists with this email, a magic link has been sent"}}}}}}}}},"/api/auth/magic-link/verify":{"post":{"tags":["Authentication"],"summary":"Verify magic link token","description":"Verify a magic link token and receive authentication tokens. The token expires after 15 minutes.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/auth/magic-link/verify\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"token\": \"magic-link-token-from-email\"}'\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["token"],"properties":{"token":{"type":"string","example":"abc123def456..."}}}}}},"responses":{"200":{"description":"Login successful","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Login successful"},"user":{"type":"object","properties":{"id":{"type":"string","example":"uuid-here"},"email":{"type":"string","example":"user@example.com"},"displayName":{"type":"string","example":"John Doe"},"isAdmin":{"type":"boolean","example":false}}},"accessToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."},"refreshToken":{"type":"string","example":"eyJhbGciOiJIUzI1NiIs..."}}}}}},"400":{"description":"Invalid or expired magic link"}}}},"/api/auth/subscription-status":{"get":{"tags":["Authentication"],"summary":"Get fresh subscription status (no caching)","description":"Get the current user's subscription status with aggressive no-cache headers. Use this endpoint for real-time status checks after payment or admin updates.\n\n**Key Features:**\n- Fresh database read (bypasses ORM caching)\n- No-cache headers prevent browser/proxy caching\n- Returns timestamp for cache validation\n\n**Use Cases:**\n- After Stripe checkout completion\n- Manual refresh button in UI\n- Periodic polling for status updates\n- After admin manually updates subscription\n\n**Example (curl):**\n```bash\ncurl -X GET \"https://api.anplexa.com/api/auth/subscription-status\" \\\n  -H \"Authorization: Bearer your-access-token\"\n```\n\n**Example (JavaScript with cache bypass):**\n```javascript\nconst response = await fetch('/api/auth/subscription-status', {\n  headers: {\n    'Authorization': `Bearer ${accessToken}`,\n    'Cache-Control': 'no-cache'\n  },\n  cache: 'no-store'\n});\nconst { subscriptionStatus, isSubscribed, credits } = await response.json();\n```","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Subscription status retrieved","content":{"application/json":{"schema":{"type":"object","properties":{"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"],"example":"subscribed"},"isSubscribed":{"type":"boolean","example":true},"credits":{"type":"integer","example":50},"hasStripeCustomer":{"type":"boolean","example":true},"hasActiveSubscription":{"type":"boolean","example":true},"timestamp":{"type":"string","format":"date-time","example":"2026-01-03T22:00:00.000Z"}}}}}},"401":{"description":"Unauthorized - invalid or missing token"},"404":{"description":"User not found"}}}},"/api/chat":{"post":{"tags":["Chat"],"summary":"Send message (streaming)","description":"Send a message and receive a streaming SSE response from the AI companion.\n\n**Rate Limits:**\n- Free tier: 50 calls/month\n- Unlimited tier: No limits\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/chat\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-API-Key: your-api-key\" \\\n  -d '{\"message\": \"Hello, how are you?\", \"preferences\": {\"length\": \"moderate\", \"style\": \"casual\"}}'\n```\n\n**Example (Node.js with streaming):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/chat', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    'X-API-Key': 'your-api-key'\n  },\n  body: JSON.stringify({\n    message: 'Hello, how are you?',\n    preferences: { length: 'moderate', style: 'casual' }\n  })\n});\n\nconst reader = response.body.getReader();\nconst decoder = new TextDecoder();\n\nwhile (true) {\n  const { done, value } = await reader.read();\n  if (done) break;\n  \n  const lines = decoder.decode(value).split('\\n');\n  for (const line of lines) {\n    if (line.startsWith('data: ')) {\n      const data = JSON.parse(line.slice(6));\n      if (data.type === 'text') {\n        process.stdout.write(data.content);\n      }\n    }\n  }\n}\n```","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["message"],"properties":{"message":{"type":"string","maxLength":10000,"example":"Hello, how are you?"},"conversationId":{"type":"string","description":"Optional, continue existing conversation"},"preferences":{"type":"object","properties":{"length":{"type":"string","enum":["brief","moderate","detailed"],"description":"Response length preference"},"style":{"type":"string","enum":["casual","thoughtful","creative"],"description":"Response style preference"}}},"personalityMode":{"type":"string","enum":["nurturing","playful","dominant"],"description":"AI personality mode for this request. Overrides user preference if specified."},"storeLocally":{"type":"boolean","default":false,"description":"If true, conversation is not stored on server"}}}}}},"responses":{"200":{"description":"SSE stream with text chunks","content":{"text/event-stream":{"schema":{"type":"string","example":"data: {\"type\":\"text\",\"content\":\"Hello\"}\n\ndata: {\"type\":\"text\",\"content\":\"!\"}\n\ndata: {\"type\":\"done\",\"conversationId\":\"uuid\"}\n\n"}}}},"403":{"description":"Rate limit exceeded","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string","example":"Message limit reached"},"message":{"type":"string","example":"All used up, please subscribe for unlimited messages."},"limit":{"type":"integer","example":50},"used":{"type":"integer","example":50},"resetsAt":{"type":"string","format":"date-time"}}}}}}}}},"/api/chat/non-streaming":{"post":{"tags":["Chat"],"summary":"Send message (non-streaming)","description":"Send a message and receive the complete response in a single JSON payload.","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["message"],"properties":{"message":{"type":"string","maxLength":10000,"example":"Tell me a joke"},"preferences":{"type":"object","properties":{"length":{"type":"string","enum":["brief","moderate","detailed"]},"style":{"type":"string","enum":["casual","thoughtful","creative"]}}}}}}}},"responses":{"200":{"description":"Complete response","content":{"application/json":{"schema":{"type":"object","properties":{"response":{"type":"string","example":"Why did the AI go to therapy? Because it had too many deep learning issues!"},"model":{"type":"string","example":"llama3.2"},"length":{"type":"string","example":"moderate"},"style":{"type":"string","example":"casual"}}}}}}}}},"/api/chat/config":{"get":{"tags":["Chat"],"summary":"Get companion config","description":"Retrieve the AI companion configuration including name, defaults, and welcome message.","responses":{"200":{"description":"Companion configuration","content":{"application/json":{"schema":{"type":"object","properties":{"name":{"type":"string","example":"Aura"},"defaultGender":{"type":"string","example":"female"},"defaultLength":{"type":"string","example":"moderate"},"defaultStyle":{"type":"string","example":"thoughtful"},"welcomeTitle":{"type":"string","example":"Welcome"},"welcomeMessage":{"type":"string","example":"Hello! I'm here to chat."}}}}}}}}},"/api/conversations":{"get":{"tags":["Conversations"],"summary":"List conversations","description":"Retrieve all conversations for the authenticated user, ordered by most recently updated.\n\n**Multiple Conversations:** Each user can have many conversations. New conversations are created automatically when you send a message to `/api/chat` without specifying a `conversationId`. To continue an existing conversation, include the `conversationId` in your chat request.\n\n**Example (curl):**\n```bash\ncurl -X GET \"https://api.anplexa.com/api/conversations\" \\\n  -H \"Authorization: Bearer your-jwt-token\"\n```\n\n**Example (Node.js):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/conversations', {\n  headers: {\n    'Authorization': 'Bearer ' + accessToken\n  }\n});\nconst { conversations } = await response.json();\nconsole.log(conversations);\n```","security":[{"bearerAuth":[]},{"apiKey":[]}],"responses":{"200":{"description":"List of conversations","content":{"application/json":{"schema":{"type":"object","properties":{"conversations":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string","example":"conv-uuid-here"},"userId":{"type":"string","example":"user-uuid-here"},"title":{"type":"string","example":"Hello, how are you?"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}}}}}}},"post":{"tags":["Conversations"],"summary":"Create new conversation","description":"Create a new conversation for the authenticated user.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/conversations\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"title\": \"My New Chat\"}'\n```\n\n**Example (Node.js):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/conversations', {\n  method: 'POST',\n  headers: {\n    'Authorization': 'Bearer ' + accessToken,\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify({ title: 'My New Chat' })\n});\nconst { conversation } = await response.json();\nconsole.log(conversation.id);\n```","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"title":{"type":"string","example":"My New Chat","description":"Title for the conversation (defaults to \"New Conversation\")"}}}}}},"responses":{"201":{"description":"Conversation created","content":{"application/json":{"schema":{"type":"object","properties":{"conversation":{"type":"object","properties":{"id":{"type":"string","example":"conv-uuid-here"},"userId":{"type":"string","example":"user-uuid-here"},"title":{"type":"string","example":"My New Chat"},"createdAt":{"type":"string","format":"date-time","example":"2024-01-01T12:00:00.000Z"},"updatedAt":{"type":"string","format":"date-time","example":"2024-01-01T12:00:00.000Z"}}}}}}}}}}},"/api/conversations/{id}":{"get":{"tags":["Conversations"],"summary":"Get conversation details","description":"Retrieve a specific conversation by ID.","security":[{"bearerAuth":[]},{"apiKey":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"Conversation ID"}],"responses":{"200":{"description":"Conversation details","content":{"application/json":{"schema":{"type":"object","properties":{"conversation":{"type":"object","properties":{"id":{"type":"string"},"userId":{"type":"string"},"title":{"type":"string"},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}}}},"404":{"description":"Conversation not found"}}},"put":{"tags":["Conversations"],"summary":"Update conversation title","description":"Update the title of a conversation.","security":[{"bearerAuth":[]},{"apiKey":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"Conversation ID"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["title"],"properties":{"title":{"type":"string","example":"Updated Chat Title"}}}}}},"responses":{"200":{"description":"Conversation updated","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Conversation updated"},"conversation":{"type":"object","properties":{"id":{"type":"string"},"title":{"type":"string"},"createdAt":{"type":"string","format":"date-time","example":"2024-01-01T12:00:00.000Z"},"updatedAt":{"type":"string","format":"date-time","example":"2024-01-01T12:30:00.000Z"}}}}}}}},"404":{"description":"Conversation not found"}}},"delete":{"tags":["Conversations"],"summary":"Delete conversation","description":"Permanently delete a conversation and all its messages.","security":[{"bearerAuth":[]},{"apiKey":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"Conversation ID"}],"responses":{"200":{"description":"Deleted successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Conversation deleted"}}}}}},"404":{"description":"Conversation not found"}}}},"/api/conversations/{id}/messages":{"get":{"tags":["Conversations"],"summary":"Get conversation messages","description":"Retrieve messages for a specific conversation with pagination support.\n\n**Example (curl):**\n```bash\ncurl -X GET \"https://api.anplexa.com/api/conversations/conv-id/messages?limit=50&offset=0\" \\\n  -H \"Authorization: Bearer your-jwt-token\"\n```","security":[{"bearerAuth":[]},{"apiKey":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"Conversation ID"},{"name":"limit","in":"query","schema":{"type":"integer","default":50},"description":"Number of messages to return"},{"name":"offset","in":"query","schema":{"type":"integer","default":0},"description":"Number of messages to skip"}],"responses":{"200":{"description":"Messages with pagination info","content":{"application/json":{"schema":{"type":"object","properties":{"messages":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"conversationId":{"type":"string"},"role":{"type":"string","enum":["user","assistant"]},"content":{"type":"string"},"createdAt":{"type":"string","format":"date-time"}}}},"pagination":{"type":"object","properties":{"limit":{"type":"integer"},"offset":{"type":"integer"},"hasMore":{"type":"boolean"}}}}}}}},"404":{"description":"Conversation not found"}}}},"/api/conversations/{id}/clear":{"post":{"tags":["Conversations"],"summary":"Clear conversation messages","description":"Delete all messages in a conversation but keep the conversation itself.","security":[{"bearerAuth":[]},{"apiKey":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"Conversation ID"}],"responses":{"200":{"description":"Messages cleared","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Conversation cleared"}}}}}},"404":{"description":"Conversation not found"}}}},"/api/settings/preferences":{"get":{"tags":["Settings"],"summary":"Get user preferences","security":[{"bearerAuth":[]},{"apiKey":[]}],"responses":{"200":{"description":"User preferences","content":{"application/json":{"schema":{"type":"object","properties":{"gender":{"type":"string","example":"female"},"customGender":{"type":"string","nullable":true},"preferredLength":{"type":"string","example":"moderate"},"preferredStyle":{"type":"string","example":"thoughtful"},"themeHue":{"type":"integer","example":200},"useOrangeAccent":{"type":"boolean","example":false}}}}}}}},"put":{"tags":["Settings"],"summary":"Update user preferences","security":[{"bearerAuth":[]},{"apiKey":[]}],"requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"gender":{"type":"string","enum":["male","female","non-binary","custom"]},"customGender":{"type":"string"},"preferredLength":{"type":"string","enum":["brief","moderate","detailed"]},"preferredStyle":{"type":"string","enum":["casual","thoughtful","creative"]},"themeHue":{"type":"integer","minimum":0,"maximum":360},"useOrangeAccent":{"type":"boolean"}}}}}},"responses":{"200":{"description":"Updated preferences"}}}},"/api/stripe/checkout":{"post":{"tags":["Stripe"],"summary":"Create checkout session","description":"Create a Stripe checkout session for subscription purchase. Returns a URL to redirect the user to complete payment.\n\n**Plans:**\n- `monthly`: ¬£2.99/month standard subscription\n- `yearly`: ¬£11.99/year (early adopter price, equivalent to ¬£0.99/month)\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/stripe/checkout\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -d '{\"plan\": \"monthly\"}'\n```\n\n**Example (Node.js):**\n```javascript\nconst response = await fetch('https://api.anplexa.com/api/stripe/checkout', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    'Authorization': 'Bearer ' + accessToken\n  },\n  body: JSON.stringify({ plan: 'monthly' })\n});\nconst { url } = await response.json();\nwindow.location.href = url; // Redirect to Stripe checkout\n```","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","properties":{"plan":{"type":"string","enum":["monthly","yearly"],"example":"monthly","description":"Subscription plan to purchase"},"priceId":{"type":"string","example":"price_xxx","description":"Alternative: pass a specific Stripe price ID directly"}}}}}},"responses":{"200":{"description":"Checkout session created","content":{"application/json":{"schema":{"type":"object","properties":{"url":{"type":"string","example":"https://checkout.stripe.com/c/pay/cs_xxx","description":"Redirect user to this URL to complete payment"}}}}}},"400":{"description":"Invalid plan or missing priceId"},"401":{"description":"Not authenticated"}}}},"/api/stripe/verify-checkout":{"post":{"tags":["Stripe"],"summary":"Verify checkout and update subscription","description":"After a successful Stripe checkout, call this endpoint to verify the session and immediately update the user's subscription status in the database.\n\n**Why use this endpoint?**\n- Stripe webhooks may take a few seconds to process\n- This endpoint verifies the checkout directly with Stripe and updates the database immediately\n- Returns the confirmed subscription status so the frontend doesn't need to poll\n\n**Security:**\n- Validates the checkout session belongs to the authenticated user\n- Checks customer ID matches if user already has a Stripe customer\n- Only updates subscription if payment is confirmed\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/stripe/verify-checkout\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer your-jwt-token\" \\\n  -d '{\"sessionId\": \"cs_test_xxx\"}'\n```\n\n**Example (Node.js):**\n```javascript\n// After redirecting back from Stripe checkout\nconst urlParams = new URLSearchParams(window.location.search);\nconst sessionId = urlParams.get('session_id');\n\nconst response = await fetch('https://api.anplexa.com/api/stripe/verify-checkout', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    'Authorization': 'Bearer ' + accessToken\n  },\n  body: JSON.stringify({ sessionId })\n});\nconst { success, subscriptionStatus, plan } = await response.json();\nif (success) {\n  // User is now subscribed, update UI immediately\n}\n```","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["sessionId"],"properties":{"sessionId":{"type":"string","example":"cs_test_a1b2c3","description":"The checkout session ID from the success URL query parameter"}}}}}},"responses":{"200":{"description":"Checkout verified and subscription updated","content":{"application/json":{"schema":{"type":"object","properties":{"success":{"type":"boolean","example":true},"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"],"example":"subscribed"},"plan":{"type":"string","enum":["monthly","yearly"],"example":"monthly"},"customerId":{"type":"string","example":"cus_xxx"},"subscriptionId":{"type":"string","example":"sub_xxx"}}}}}},"400":{"description":"Missing sessionId or invalid session data"},"401":{"description":"Not authenticated"},"403":{"description":"Session does not belong to this user"}}}},"/api/stripe/subscription":{"get":{"tags":["Stripe"],"summary":"Get subscription status","description":"Get the current user's subscription status and details.","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Subscription status","content":{"application/json":{"schema":{"type":"object","properties":{"status":{"type":"string","enum":["subscribed","not_subscribed"],"example":"subscribed"},"subscription":{"type":"object","nullable":true,"properties":{"id":{"type":"string"},"status":{"type":"string"},"currentPeriodEnd":{"type":"string","format":"date-time"}}}}}}}},"401":{"description":"Not authenticated"}}}},"/api/stripe/portal":{"post":{"tags":["Stripe"],"summary":"Create customer portal session","description":"Create a Stripe customer portal session for the user to manage their subscription, update payment methods, or cancel.","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Portal session created","content":{"application/json":{"schema":{"type":"object","properties":{"url":{"type":"string","example":"https://billing.stripe.com/session/xxx","description":"Redirect user to this URL"}}}}}},"400":{"description":"User has no Stripe customer"},"401":{"description":"Not authenticated"}}}},"/api/stripe/publishable-key":{"get":{"tags":["Stripe"],"summary":"Get Stripe publishable key","description":"Get the Stripe publishable key for client-side Stripe.js initialization.","responses":{"200":{"description":"Publishable key","content":{"application/json":{"schema":{"type":"object","properties":{"publishableKey":{"type":"string","example":"pk_live_xxx"}}}}}}}}},"/api/stripe/products":{"get":{"tags":["Stripe"],"summary":"List products with prices","description":"Get all active Stripe products and their prices.","responses":{"200":{"description":"List of products","content":{"application/json":{"schema":{"type":"object","properties":{"products":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"name":{"type":"string"},"description":{"type":"string"},"prices":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"unitAmount":{"type":"integer"},"currency":{"type":"string"},"recurring":{"type":"object"}}}}}}}}}}}}}}},"/api/admin/config":{"get":{"tags":["Admin üîê"],"summary":"Get companion config (admin)","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Full companion configuration"}}},"put":{"tags":["Admin üîê"],"summary":"Update companion config","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Updated configuration"}}}},"/api/admin/system-prompts":{"get":{"tags":["Admin üîê"],"summary":"List all system prompts","description":"Retrieve all system prompt versions with metadata. Only one prompt can be active at a time.","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Array of system prompts","content":{"application/json":{"schema":{"type":"object","properties":{"prompts":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string","example":"uuid-here"},"name":{"type":"string","example":"Anplexa v2"},"content":{"type":"string","example":"You are Anplexa..."},"version":{"type":"integer","example":2},"isActive":{"type":"boolean","example":true},"notes":{"type":"string","example":"Updated personality traits","nullable":true},"createdAt":{"type":"string","format":"date-time"},"createdBy":{"type":"string","example":"user-uuid","nullable":true}}}},"activePromptId":{"type":"string","example":"uuid-here","nullable":true}}}}}}}},"post":{"tags":["Admin üîê"],"summary":"Create new system prompt version","description":"Create a new version of the system prompt. The prompt will be inactive by default.","security":[{"bearerAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["name","content"],"properties":{"name":{"type":"string","example":"Anplexa v2","description":"Name for this prompt version"},"content":{"type":"string","example":"You are Anplexa...","description":"The full system prompt content. Use {{USER_NAME}} placeholder for personalization."},"notes":{"type":"string","example":"Updated personality","description":"Optional notes about changes"}}}}}},"responses":{"201":{"description":"Prompt created successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"System prompt created"},"prompt":{"type":"object","properties":{"id":{"type":"string"},"name":{"type":"string"},"version":{"type":"integer"},"isActive":{"type":"boolean"}}}}}}}},"400":{"description":"Invalid input"}}}},"/api/admin/system-prompts/{id}":{"get":{"tags":["Admin üîê"],"summary":"Get system prompt by ID","description":"Retrieve a specific system prompt with full content.","security":[{"bearerAuth":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"System prompt ID"}],"responses":{"200":{"description":"System prompt details","content":{"application/json":{"schema":{"type":"object","properties":{"prompt":{"type":"object","properties":{"id":{"type":"string"},"name":{"type":"string"},"content":{"type":"string"},"version":{"type":"integer"},"isActive":{"type":"boolean"},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"}}}}}}}},"404":{"description":"Prompt not found"}}},"delete":{"tags":["Admin üîê"],"summary":"Delete system prompt","description":"Delete a system prompt version. Cannot delete the currently active prompt.","security":[{"bearerAuth":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"System prompt ID"}],"responses":{"200":{"description":"Prompt deleted successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"System prompt deleted"}}}}}},"400":{"description":"Cannot delete active prompt"},"404":{"description":"Prompt not found"}}}},"/api/admin/system-prompts/{id}/activate":{"put":{"tags":["Admin üîê"],"summary":"Activate system prompt","description":"Set a system prompt as the active prompt. This will deactivate any other active prompt.","security":[{"bearerAuth":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"System prompt ID"}],"responses":{"200":{"description":"Prompt activated successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"System prompt activated"},"prompt":{"type":"object","properties":{"id":{"type":"string"},"name":{"type":"string"},"isActive":{"type":"boolean","example":true}}}}}}}},"404":{"description":"Prompt not found"}}}},"/api/admin/users":{"get":{"tags":["Admin üîê"],"summary":"List all users","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Array of users"}}}},"/api/admin/users/{id}/subscription":{"put":{"tags":["Admin üîê"],"summary":"Update user subscription status","description":"Set user subscription to subscribed or not_subscribed.","security":[{"bearerAuth":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"User ID"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["subscriptionStatus"],"properties":{"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"],"example":"subscribed"}}}}}},"responses":{"200":{"description":"Subscription status updated"},"404":{"description":"User not found"}}}},"/api/admin/users/{id}/credits":{"put":{"tags":["Admin üîê"],"summary":"Update user credits","description":"Set, add, or subtract credits for a user.","security":[{"bearerAuth":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"User ID"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["credits"],"properties":{"credits":{"type":"integer","example":100,"description":"Number of credits"},"operation":{"type":"string","enum":["set","add","subtract"],"default":"set","description":"Operation to perform"}}}}}},"responses":{"200":{"description":"Credits updated with previous and new values"},"404":{"description":"User not found"}}}},"/api/admin/users/{id}/billing":{"get":{"tags":["Admin üîê"],"summary":"Get user billing info","description":"Get subscription status and credits for a user.","security":[{"bearerAuth":[]}],"parameters":[{"name":"id","in":"path","required":true,"schema":{"type":"string"},"description":"User ID"}],"responses":{"200":{"description":"User billing info (subscription + credits)"},"404":{"description":"User not found"}}}},"/api/admin/ollama/test":{"post":{"tags":["Admin üîê"],"summary":"Test Ollama connection","security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Connection status and available models"}}}},"/api/health":{"get":{"tags":["Health"],"summary":"Basic health check","responses":{"200":{"description":"Server status","content":{"application/json":{"schema":{"type":"object","properties":{"status":{"type":"string","example":"ok"},"timestamp":{"type":"string","format":"date-time"}}}}}}}}},"/api/health/database":{"get":{"tags":["Health"],"summary":"Database health check","responses":{"200":{"description":"Database connection status"}}}},"/api/health/ollama":{"get":{"tags":["Health"],"summary":"Ollama health check","responses":{"200":{"description":"Ollama connection status and latency"}}}},"/api/health/full":{"get":{"tags":["Health"],"summary":"Full system health check","responses":{"200":{"description":"All system checks"}}}},"/api/webhooks/subscription":{"post":{"tags":["Webhooks"],"summary":"Update subscription via webhook","description":"Webhook endpoint to update user subscription status. Requires X-Webhook-Secret header.","parameters":[{"name":"X-Webhook-Secret","in":"header","required":true,"schema":{"type":"string"},"description":"Webhook authentication secret"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["userId","subscriptionStatus"],"properties":{"userId":{"type":"string","format":"uuid","description":"User ID"},"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"]},"eventType":{"type":"string","description":"Optional event type identifier"}}}}}},"responses":{"200":{"description":"Subscription status updated"},"401":{"description":"Unauthorized - invalid webhook secret"},"404":{"description":"User not found"}}}},"/api/webhooks/credits":{"post":{"tags":["Webhooks"],"summary":"Update credits via webhook","description":"Webhook endpoint to update user credits. Requires X-Webhook-Secret header.","parameters":[{"name":"X-Webhook-Secret","in":"header","required":true,"schema":{"type":"string"},"description":"Webhook authentication secret"}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["userId","credits"],"properties":{"userId":{"type":"string","format":"uuid","description":"User ID"},"credits":{"type":"integer","description":"Number of credits"},"operation":{"type":"string","enum":["set","add","subtract"],"default":"set"},"eventType":{"type":"string","description":"Optional event type identifier"}}}}}},"responses":{"200":{"description":"Credits updated"},"401":{"description":"Unauthorized - invalid webhook secret"},"404":{"description":"User not found"}}}},"/api/webhooks/health":{"get":{"tags":["Webhooks"],"summary":"Webhook health check","description":"Check if webhook endpoint is configured and ready.","responses":{"200":{"description":"Webhook configuration status"}}}},"/api/register-subscriber":{"post":{"tags":["Public"],"summary":"Register email subscriber (no auth required)","description":"Register a new subscriber from a landing page or signup form. This is a public endpoint designed for lead capture - no authentication required.\n\n**Use Cases:**\n- Landing page email capture forms\n- Waitlist signup forms\n- Lead generation funnels\n\n**CRM Integration:**\nNew leads are automatically enrolled in email retention sequences:\n- `funnelType: \"waitlist\"` ‚Üí W1-W5 email sequence\n- `funnelType: \"direct\"` ‚Üí D1-D4 email sequence\n\n**Rate Limiting:** 10 requests per minute per IP address.\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/register-subscriber\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"email\": \"user@example.com\", \"funnelType\": \"waitlist\", \"persona\": \"curious\"}'\n```\n\n**Example (JavaScript):**\n```javascript\nconst response = await fetch('/api/register-subscriber', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    email: 'user@example.com',\n    displayName: 'John',\n    funnelType: 'direct',\n    entrySource: 'landing'\n  })\n});\nconst data = await response.json();\n// { status: 'success', message: 'Thanks for signing up!', leadId: 'uuid' }\n```","requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com"},"displayName":{"type":"string","example":"John","description":"Optional display name"},"chatName":{"type":"string","example":"Johnny","description":"Preferred name for AI to use"},"funnelType":{"type":"string","enum":["waitlist","direct"],"default":"direct","description":"Determines which email sequence is used"},"persona":{"type":"string","enum":["lonely","curious","privacy"],"description":"User persona for personalized emails"},"entrySource":{"type":"string","enum":["instagram","tiktok","reddit","search","retargeting","organic","landing"],"description":"Where the user came from"},"utm_source":{"type":"string","description":"UTM source parameter"},"utm_medium":{"type":"string","description":"UTM medium parameter"},"utm_campaign":{"type":"string","description":"UTM campaign parameter"}}}}}},"responses":{"200":{"description":"Email already registered (not an error)","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Thanks! You're already on our list."},"status":{"type":"string","enum":["existing_lead","existing_subscriber"]}}}}}},"201":{"description":"Subscriber registered successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Thanks for signing up! Check your email for next steps."},"status":{"type":"string","enum":["success","existing_lead","existing_subscriber"],"example":"success"},"leadId":{"type":"string","example":"uuid-here"}}}}}},"400":{"description":"Invalid email address"},"429":{"description":"Rate limit exceeded - too many requests"}}}},"/api/funnel/users":{"post":{"tags":["Funnel"],"summary":"Create user from funnel","description":"Create a new user account from an external funnel application. Returns user details, API key, and authentication tokens.\n\n**Authentication:** Requires Funnel API key (e.g., `fk_...`) sent as a **Bearer token** in the `Authorization` header.\n\n**Important:** Legacy `X-API-Key` header is no longer supported for funnel endpoints. You must use `Authorization: Bearer your_key_here`.\n\n**CRM Integration:**\nWhen creating users, you can pass additional CRM fields to segment them for email retention sequences:\n- `funnelType`: \"waitlist\" triggers W1-W5 sequence, \"direct\" triggers D1-D4 sequence\n- `persona`: User segment for personalized emails (lonely/curious/privacy)\n- `entrySource`: Track where user came from (e.g., \"landing_page\", \"referral\")\n\n**Flow:**\n1. Funnel app calls this endpoint to create user\n2. Returns userId, apiKey, and tokens\n3. CRM automatically schedules email retention sequence based on funnelType\n4. Funnel can then call /api/funnel/checkout to get Stripe payment URL\n5. After payment, Stripe webhooks automatically update subscription status and cancel pending retention emails\n\n**Example (curl) - Waitlist user:**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/funnel/users\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\"email\": \"user@example.com\", \"password\": \"securepass123\", \"displayName\": \"John\", \"funnelType\": \"waitlist\", \"persona\": \"curious\", \"entrySource\": \"landing_page\"}'\n```\n\n**Example (curl) - Direct signup:**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/funnel/users\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\"email\": \"user@example.com\", \"password\": \"securepass123\", \"funnelType\": \"direct\"}'\n```\n\n**Example (curl) - Pre-subscribed user (paid via funnel):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/funnel/users\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\"email\": \"user@example.com\", \"password\": \"securepass123\", \"subscriptionStatus\": \"subscribed\", \"stripeCustomerId\": \"cus_xxx\", \"stripeSubscriptionId\": \"sub_xxx\"}'\n```\n\n**Note:** \n- Your funnel app can handle Stripe payments directly and pass subscription info here\n- Subscribed users skip CRM email sequences automatically\n- If you don't have Stripe on your funnel, use /api/funnel/checkout instead","security":[{"funnelAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email","password"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com"},"password":{"type":"string","minLength":6,"example":"securepass123"},"displayName":{"type":"string","example":"John Doe"},"chatName":{"type":"string","maxLength":50,"example":"Johnny","description":"Name for AI to address user"},"funnelType":{"type":"string","enum":["waitlist","direct"],"example":"waitlist","description":"Funnel type for CRM email sequences. \"waitlist\" = W1-W5 sequence, \"direct\" = D1-D4 sequence"},"persona":{"type":"string","enum":["lonely","curious","privacy"],"example":"curious","description":"User persona for personalized email content"},"entrySource":{"type":"string","enum":["instagram","tiktok","reddit","search","retargeting","organic"],"example":"instagram","description":"Track where user originated from"},"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"],"default":"not_subscribed","example":"subscribed","description":"Set to \"subscribed\" if user already paid via your funnel. Skips CRM emails."},"stripeCustomerId":{"type":"string","example":"cus_xxx","description":"Stripe customer ID if payment handled on funnel side"},"stripeSubscriptionId":{"type":"string","example":"sub_xxx","description":"Stripe subscription ID if payment handled on funnel side"}}}}}},"responses":{"201":{"description":"User created successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"User created successfully"},"user":{"type":"object","properties":{"id":{"type":"string","example":"uuid-here"},"email":{"type":"string","example":"user@example.com"},"displayName":{"type":"string","example":"John Doe"},"funnelType":{"type":"string","example":"waitlist"},"persona":{"type":"string","example":"curious","nullable":true},"entrySource":{"type":"string","example":"landing_page","nullable":true},"stage":{"type":"string","example":"waitlist"}}},"apiKey":{"type":"string","example":"tc_abc123...","description":"API key for chat endpoints"},"accessToken":{"type":"string","example":"eyJ..."},"refreshToken":{"type":"string","example":"eyJ..."},"emailSequenceScheduled":{"type":"string","example":"waitlist","description":"Which email sequence was scheduled (waitlist/direct)"}}}}}},"400":{"description":"Validation error or email already registered"},"401":{"description":"Missing authorization header"},"403":{"description":"Invalid funnel API secret"}}}},"/api/funnel/checkout":{"post":{"tags":["Funnel"],"summary":"Create Stripe checkout for user","description":"Generate a Stripe checkout URL for a user. Redirect the user to this URL to complete payment.\n\n**Authentication:** Requires Funnel API key (e.g., `fk_...`) sent as a **Bearer token** in the `Authorization` header.\n\n**Important:** Legacy `X-API-Key` header is no longer supported for funnel endpoints. You must use `Authorization: Bearer your_key_here`.\n\n**Flow:**\n1. Call this endpoint with userId\n2. Redirect user to the returned checkoutUrl\n3. User completes payment on Stripe\n4. Stripe webhooks automatically update subscription status\n5. Check status via /api/funnel/subscription/:userId\n\n**Pricing Plans:**\n- `yearly` / `early`: ¬£11.99/year (early adopter rate = ¬£0.99/mo)\n- `monthly` / `standard`: ¬£2.99/month\n\n**Example (curl) - Early adopter yearly:**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/funnel/checkout\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\"userId\": \"user-uuid-here\", \"plan\": \"yearly\"}'\n```\n\n**Example (curl) - Standard monthly:**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/funnel/checkout\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\"userId\": \"user-uuid-here\", \"plan\": \"monthly\"}'\n```","security":[{"funnelAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["userId"],"properties":{"userId":{"type":"string","example":"user-uuid-here"},"plan":{"type":"string","enum":["yearly","monthly","early","standard"],"default":"monthly","description":"yearly/early = ¬£11.99/year, monthly/standard = ¬£2.99/month"},"successUrl":{"type":"string","format":"uri","description":"Custom success redirect URL"},"cancelUrl":{"type":"string","format":"uri","description":"Custom cancel redirect URL"}}}}}},"responses":{"200":{"description":"Checkout session created","content":{"application/json":{"schema":{"type":"object","properties":{"checkoutUrl":{"type":"string","example":"https://checkout.stripe.com/..."},"sessionId":{"type":"string","example":"cs_..."}}}}}},"401":{"description":"Missing authorization header"},"403":{"description":"Invalid funnel API secret"},"404":{"description":"User not found or Unlimited plan not configured"}}}},"/api/funnel/subscription/{userId}":{"get":{"tags":["Funnel"],"summary":"Get user subscription status","description":"Check a user's current subscription status.\n\n**Authentication:** Requires Funnel API key (e.g., `fk_...`) sent as a **Bearer token** in the `Authorization` header.\n\n**Important:** Legacy `X-API-Key` header is no longer supported for funnel endpoints. You must use `Authorization: Bearer your_key_here`.\n\n**Example (curl):**\n```bash\ncurl -X GET \"https://api.anplexa.com/api/funnel/subscription/user-uuid-here\" \\\n  -H \"Authorization: Bearer fk_your_key_here\"\n```","security":[{"funnelAuth":[]}],"parameters":[{"name":"userId","in":"path","required":true,"schema":{"type":"string"},"description":"User ID"}],"responses":{"200":{"description":"Subscription status","content":{"application/json":{"schema":{"type":"object","properties":{"userId":{"type":"string"},"email":{"type":"string"},"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"]},"isSubscribed":{"type":"boolean"},"stripeCustomerId":{"type":"string","nullable":true},"stripeSubscriptionId":{"type":"string","nullable":true}}}}}},"401":{"description":"Missing authorization header"},"403":{"description":"Invalid funnel API secret"},"404":{"description":"User not found"}}}},"/api/funnel/subscription":{"put":{"tags":["Funnel"],"summary":"Update user subscription status","description":"Manually update a user's subscription status. Use this for manual overrides or integrations that bypass Stripe webhooks.\n\n**Authentication:** Requires Funnel API key (e.g., `fk_...`) sent as a **Bearer token** in the `Authorization` header.\n\n**Important:** Legacy `X-API-Key` header is no longer supported for funnel endpoints. You must use `Authorization: Bearer your_key_here`.\n\n**Example (curl):**\n```bash\ncurl -X PUT \"https://api.anplexa.com/api/funnel/subscription\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\"userId\": \"user-uuid-here\", \"subscriptionStatus\": \"subscribed\"}'\n```","security":[{"funnelAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["userId","subscriptionStatus"],"properties":{"userId":{"type":"string","example":"user-uuid-here"},"subscriptionStatus":{"type":"string","enum":["subscribed","not_subscribed"]},"stripeCustomerId":{"type":"string","description":"Optional Stripe customer ID"},"stripeSubscriptionId":{"type":"string","description":"Optional Stripe subscription ID"}}}}}},"responses":{"200":{"description":"Subscription updated","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Subscription updated successfully"},"userId":{"type":"string"},"subscriptionStatus":{"type":"string"}}}}}},"401":{"description":"Missing authorization header"},"403":{"description":"Invalid funnel API secret"},"404":{"description":"User not found"}}}},"/api/funnel/users/{userId}":{"get":{"tags":["Funnel"],"summary":"Get user details","description":"Retrieve full user profile including subscription status and preferences.","security":[{"funnelAuth":[]}],"parameters":[{"name":"userId","in":"path","required":true,"schema":{"type":"string"},"description":"User ID"}],"responses":{"200":{"description":"User details","content":{"application/json":{"schema":{"type":"object","properties":{"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"displayName":{"type":"string"},"chatName":{"type":"string","nullable":true},"personalityMode":{"type":"string"},"preferredGender":{"type":"string"},"subscriptionStatus":{"type":"string"},"isSubscribed":{"type":"boolean"},"createdAt":{"type":"string"}}}}}}}},"404":{"description":"User not found"}}}},"/api/funnel/users/{userId}/api-key":{"post":{"tags":["Funnel"],"summary":"Generate new API key for user","description":"Create an additional API key for a user.","security":[{"funnelAuth":[]}],"parameters":[{"name":"userId","in":"path","required":true,"schema":{"type":"string"},"description":"User ID"}],"requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"name":{"type":"string","example":"Mobile App Key","description":"Optional name for the API key"}}}}}},"responses":{"201":{"description":"API key created","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"API key created successfully"},"apiKey":{"type":"string","example":"tc_abc123..."},"keyPrefix":{"type":"string","example":"tc_abc12"}}}}}},"404":{"description":"User not found"}}}},"/api/funnel/profile":{"post":{"tags":["Funnel"],"summary":"Store Amplexa funnel profile","description":"Store Amplexa personality funnel data for a user. This data enhances AI responses during new chat sessions by providing personality insights.\n\n**Authentication:** Requires Funnel API key (e.g., `fk_...`) sent as a **Bearer token** in the `Authorization` header.\n\n**Important:** Legacy `X-API-Key` header is no longer supported for funnel endpoints. You must use `Authorization: Bearer your_key_here`.\n\n**Funnel Types:**\n- **A**: Quietly Lonely - For those seeking a safe space to talk\n- **B**: Curious / Fantasy-Open - For those exploring connection and fantasy\n- **C**: Privacy-First / Neurodivergent - For those who value predictability and safety\n- **D**: Late Night Thinker - For those with thoughts that keep them awake\n- **E**: Emotional Explorer - For those processing feelings and experiences\n- **F**: Creative Seeker - For those who want imaginative conversation\n\n**How It Works:**\n1. User completes funnel questionnaire on external site\n2. Funnel app calls this endpoint with user's email and responses\n3. Profile data is stored in user's account (optional, not mandatory)\n4. When user starts a new chat (newChat=true), AI receives personality context\n5. AI tailors ice-breaker response (max 1-2 sentences) based on:\n   - Primary need (Connection, Safety, Understanding, etc.)\n   - Communication style (Gentle, Open, Structured, etc.)\n   - Conversation pace (Slow, Flexible, Thoughtful, etc.)\n   - Personality tags (Night Owl Processor, Creative Escapist, etc.)\n\n**Example (curl):**\n```bash\ncurl -X POST \"https://api.anplexa.com/api/funnel/profile\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer fk_your_key_here\" \\\n  -d '{\n    \"email\": \"user@example.com\",\n    \"funnel\": \"A\",\n    \"funnelName\": \"Quietly Lonely\",\n    \"responses\": [\n      {\n        \"questionId\": \"q1\",\n        \"questionText\": \"This is private. Why are you here right now?\",\n        \"answer\": \"I feel lonely sometimes\",\n        \"answerIndex\": 0\n      },\n      {\n        \"questionId\": \"q2\",\n        \"questionText\": \"When do you usually feel like talking?\",\n        \"answer\": \"Late at night\",\n        \"answerIndex\": 0\n      },\n      {\n        \"questionId\": \"q3\",\n        \"questionText\": \"What matters most to you?\",\n        \"answer\": \"Feeling heard\",\n        \"answerIndex\": 1\n      }\n    ],\n    \"profile\": {\n      \"primaryNeed\": \"Connection\",\n      \"communicationStyle\": \"Gentle, patient\",\n      \"pace\": \"Slow\",\n      \"tags\": [\"Night Owl Processor\", \"Validation Seeker\"]\n    },\n    \"timestamp\": \"2026-01-01T00:00:00.000Z\"\n  }'\n```\n\n**Note:** See AMPLEXA_FUNNEL_MAPPING.md for complete funnel reference and all example payloads.","security":[{"funnelAuth":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"type":"object","required":["email","funnel","funnelName"],"properties":{"email":{"type":"string","format":"email","example":"user@example.com","description":"User email to identify account"},"funnel":{"type":"string","enum":["A","B","C","D","E","F"],"example":"A","description":"Funnel identifier"},"funnelName":{"type":"string","example":"Quietly Lonely","description":"Full funnel name"},"responses":{"type":"array","description":"Optional array of question responses","items":{"type":"object","properties":{"questionId":{"type":"string","example":"q1"},"questionText":{"type":"string","example":"Why are you here?"},"answer":{"type":"string","example":"I feel lonely sometimes"},"answerIndex":{"type":"number","minimum":0,"maximum":3,"example":0}}}},"profile":{"type":"object","description":"Optional personality profile derived from funnel","properties":{"primaryNeed":{"type":"string","example":"Connection","description":"Connection, Exploration, Safety, Processing, Understanding, or Imagination"},"communicationStyle":{"type":"string","example":"Gentle, patient","description":"Preferred communication approach"},"pace":{"type":"string","example":"Slow","description":"Conversation pace preference"},"tags":{"type":"array","items":{"type":"string"},"example":["Night Owl Processor","Validation Seeker"],"description":"Personality tags"}}},"timestamp":{"type":"string","format":"date-time","description":"When funnel was completed (optional, defaults to current time)"}}}}}},"responses":{"200":{"description":"Profile stored successfully","content":{"application/json":{"schema":{"type":"object","properties":{"message":{"type":"string","example":"Amplexa funnel profile stored successfully"},"userId":{"type":"string","example":"user-uuid-here"},"email":{"type":"string","example":"user@example.com"},"funnel":{"type":"string","example":"A"},"funnelName":{"type":"string","example":"Quietly Lonely"}}}}}},"400":{"description":"Validation error - invalid funnel data"},"401":{"description":"Missing authorization header"},"403":{"description":"Invalid funnel API secret"},"404":{"description":"User not found with this email"}}}}},"components":{"securitySchemes":{"bearerAuth":{"type":"http","scheme":"bearer","bearerFormat":"JWT","description":"JWT Bearer token obtained from /api/auth/login"},"apiKey":{"type":"apiKey","in":"header","name":"X-API-Key","description":"API key obtained from dashboard after subscribing"},"funnelAuth":{"type":"http","scheme":"bearer","description":"Funnel API key (fk_xxx) generated from admin dashboard at /admin/funnel-keys. Include as: Authorization: Bearer fk_your_key_here"}}}}